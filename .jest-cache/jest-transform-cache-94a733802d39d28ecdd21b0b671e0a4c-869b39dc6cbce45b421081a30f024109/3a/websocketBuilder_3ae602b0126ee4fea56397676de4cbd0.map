{"version":3,"names":["getOrPersistClientId","storageKey","passedClientId","clientId","storedClientId","window","localStorage","getItem","initialFromStorage","Math","random","toString","substr","setItem","_import_meta_env","globalThis","importMeta","env","global","import","meta","undefined","DEV","console","log","passedIn","finalClientId","resolveWebSocketBase","_import_meta_env2","baseUrl","VITE_WS_URL","includes","warn","replace","protocol","location","host","hostname","port","buildWebSocketUrl","options","providedClientId","role","version","providedBaseUrl","url","URL","searchParams","set","String","result","error","stack","Error","params","URLSearchParams","fallbackUrl","validateWebSocketUrl"],"sources":["websocketBuilder.ts"],"sourcesContent":["/**\r\n * Canonical WebSocket URL Builder\r\n * Single source of truth for WebSocket URL construction\r\n */\r\n\r\ninterface WebSocketUrlOptions {\r\n  clientId?: string;\r\n  role?: string;\r\n  version?: number;\r\n  baseUrl?: string;\r\n}\r\n\r\n// Client ID persistence utility\r\nexport function getOrPersistClientId(storageKey = 'ws_client_id', passedClientId?: string): string {\r\n  let clientId = passedClientId;\r\n  \r\n  // Try to get from storage first\r\n  const storedClientId = window.localStorage.getItem(storageKey);\r\n  const initialFromStorage = !!storedClientId;\r\n  \r\n  if (!clientId && storedClientId) {\r\n    clientId = storedClientId;\r\n  }\r\n  \r\n  // Generate new one if none available\r\n  if (!clientId) {\r\n    clientId = `client_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n  \r\n  // Always persist to storage\r\n  window.localStorage.setItem(storageKey, clientId);\r\n  \r\n  // Dev-only diagnostic log\r\n  const _import_meta_env = (globalThis as any).importMeta?.env || (global as any).importMeta?.env || (typeof window !== 'undefined' ? (window as any).import?.meta?.env : undefined) || {};\r\n\r\n  if (_import_meta_env.DEV) {\r\n    // eslint-disable-next-line no-console\r\n    console.log('[ClientIdDiag]', {\r\n      initialFromStorage,\r\n      passedIn: !!passedClientId,\r\n      finalClientId: clientId\r\n    });\r\n  }\r\n  \r\n  return clientId;\r\n}\r\n\r\n// Environment resolution helper\r\nexport function resolveWebSocketBase(): string {\r\n  const _import_meta_env2 = (globalThis as any).importMeta?.env || (global as any).importMeta?.env || (typeof window !== 'undefined' ? (window as any).import?.meta?.env : undefined) || {};\r\n\r\n  let baseUrl = _import_meta_env2.VITE_WS_URL;\r\n  \r\n  // Check for legacy path in environment and sanitize\r\n  if (baseUrl && baseUrl.includes('client_/ws')) {\r\n    // eslint-disable-next-line no-console\r\n    console.warn('[EnvDiag][LegacyInEnv] Legacy WebSocket path detected in environment, sanitizing:', baseUrl);\r\n    baseUrl = baseUrl.replace(/\\/client_\\/ws.*$/, '');\r\n  }\r\n  \r\n  // Default fallback\r\n  if (!baseUrl) {\r\n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n    const host = window.location.hostname;\r\n    const port = host === 'localhost' ? '8000' : window.location.port;\r\n    baseUrl = `${protocol}//${host}${port ? `:${port}` : ''}`;\r\n  }\r\n  \r\n  return baseUrl;\r\n}\r\n\r\n/**\r\n * Canonical WebSocket URL Builder\r\n * MUST be used for all WebSocket URL construction\r\n */\r\nexport function buildWebSocketUrl(options: WebSocketUrlOptions = {}): string {\r\n  const {\r\n    clientId: providedClientId,\r\n    role = 'frontend',\r\n    version = 1,\r\n    baseUrl: providedBaseUrl\r\n  } = options;\r\n  \r\n  // Resolve base URL\r\n  const baseUrl = providedBaseUrl || resolveWebSocketBase();\r\n\r\n  // Runtime-safe import.meta.env accessor for DEV checks inside this function\r\n  const _import_meta_env2 = (globalThis as any).importMeta?.env || (global as any).importMeta?.env || (typeof window !== 'undefined' ? (window as any).import?.meta?.env : undefined) || {};\r\n  \r\n  // Get or generate client ID\r\n  const clientId = getOrPersistClientId('ws_client_id', providedClientId);\r\n  \r\n  try {\r\n    // Use URL constructor for robust path building\r\n    const url = new URL('/ws/client', baseUrl);\r\n    url.searchParams.set('client_id', clientId);\r\n    url.searchParams.set('version', String(version));\r\n    url.searchParams.set('role', role);\r\n    \r\n    const result = url.toString();\r\n    \r\n    // Defensive assertion - dev only\r\n    if (_import_meta_env2.DEV) {\r\n      if (result.includes('client_/ws')) {\r\n        // eslint-disable-next-line no-console\r\n        console.error('[WSBuildDiag][LegacyDetected]', { \r\n          url: result, \r\n          stack: new Error().stack \r\n        });\r\n        throw new Error('Legacy websocket path constructed after migration');\r\n      }\r\n      \r\n      // eslint-disable-next-line no-console\r\n      console.log('[WSBuildDiag] Built canonical WebSocket URL:', result);\r\n    }\r\n    \r\n    return result;\r\n  } catch (error) {\r\n    // Fallback with defensive assertion\r\n    const params = new URLSearchParams();\r\n    params.set('client_id', clientId);\r\n    params.set('version', String(version));\r\n    params.set('role', role);\r\n    \r\n    const fallbackUrl = `${baseUrl}/ws/client?${params.toString()}`;\r\n    \r\n    // Defensive assertion on fallback too\r\n    if (_import_meta_env2.DEV && fallbackUrl.includes('client_/ws')) {\r\n      // eslint-disable-next-line no-console\r\n      console.error('[WSBuildDiag][LegacyDetected] Even fallback created legacy path!', { \r\n        url: fallbackUrl, \r\n        error,\r\n        stack: new Error().stack \r\n      });\r\n      throw new Error('Legacy websocket path constructed in fallback after migration');\r\n    }\r\n    \r\n  if (_import_meta_env2.DEV) {\r\n      // eslint-disable-next-line no-console\r\n      console.warn('[WSBuildDiag] URL constructor failed, using fallback:', fallbackUrl, error);\r\n    }\r\n    \r\n    return fallbackUrl;\r\n  }\r\n}\r\n\r\n// Validate that a URL doesn't contain legacy patterns\r\nexport function validateWebSocketUrl(url: string): boolean {\r\n  return !url.includes('client_/ws');\r\n}"],"mappings":"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","ignoreList":[]}