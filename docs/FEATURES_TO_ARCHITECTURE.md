**Features To Architecture Mapping**

This document maps prioritized features to backend services, frontend components, data models, API endpoints, third-party integrations, and ML components. It's intended to guide implementation and review for the "manus plan" free-ingestion work and related PropFinder features.

1) Switch ingestion to free data sources (Phase 2)
- **Description:** Replace paid providers with free sources (MLB Stats API, Baseball Savant) for prop ingestion. Add scheduler, caching, backfill, metrics, and staged rollout.
- **Backend services:**
  - `backend/ingestion/mlb_stats_connector.py` (connector)
  - `backend/ingestion/baseball_savant_connector.py` (connector)
  - `backend/services/unified_data_fetcher.py` (registry + unified API)
  - `backend/ingestion/scheduler_runner.py` (scheduler runner + runner.run_once/start_scheduler)
  - `backend/services/cache.py` (Redis wrapper + in-memory fallback)
  - `backend/metrics/ingestion_metrics.py` (in-process metrics; integrate with Prometheus)
- **Frontend components:**
  - `frontend/src/hooks/usePropFinderData.tsx` (ensure mapping includes `sport` context)
  - `frontend/src/components/dashboard/PropFinderDashboard.tsx` (display cached snapshots)
- **Data models / schemas:**
  - PropOpportunity / FeaturedProp (shared between backend & frontend)
  - Snapshot object: { game_id, timestamp, props: FeaturedProp[] }
- **API endpoints:**
  - `GET /api/propfinder/opportunities` (read snapshots)
  - `POST /api/ingestion/run-once` (admin trigger to run `run_once()`)
  - `POST /api/ingestion/backfill` (admin backfill control)
- **Third-party integrations:** MLB Stats API, Baseball Savant (Statcast)
- **ML components / fallback:**
  - Use existing ML scoring services only on-demand; lazy import heavy ML libraries with try/except.

2) Integration testing & monitoring
- **Description:** Add integration tests for connectors and metrics; expose Prometheus metrics for ingestion.
- **Backend services:** integrate `backend/metrics/ingestion_metrics.py` with existing Prometheus registry (or add small adapter)
- **CI:** add GitHub Actions workflow to run `pytest` and static checks. Default `USE_FREE_INGESTION=false` in CI unless explicitly testing staging.

3) Backfill / snapshot rehydration
- **Description:** Worker to rehydrate historical snapshots into cache or DB.
- **Backend services:** new `backend/ingestion/backfill_worker.py` (idempotent), storage adapter (S3 / DB), admin route to trigger and monitor backfill.

4) Deprecate paid-provider keys
- **Description:** Remove two paid SDKs, mark env keys deprecated, update `.env.example`, and add migration notes.
- **Files:** update `backend/.env.example`, `API_AUDIT_REPORT.md`, `README.md` runbook.

Next steps and owners
- Short-term (this sprint):
  - Add CI workflow to run tests and static checks (owner: infra)
  - Integrate Prometheus adapter for `IngestionMetrics` (owner: backend)
  - Implement admin endpoints for run-once and backfill (owner: backend)
- Medium-term:
  - Implement backfill worker and storage adapter
  - Add end-to-end tests covering PropFinder UI â†” snapshots
  - Remove paid-provider SDKs after verification

Acceptance criteria (per feature)
- Switch ingestion to free data sources:
  - Scheduler run_once stores snapshots in cache/DB
  - Metrics emitted for successes/failures/latency
  - `USE_FREE_INGESTION` feature flag controls startup wiring
  - Scheduler run_once stores snapshots in cache/DB
  - Metrics emitted for successes/failures/latency
  - `USE_FREE_INGESTION` feature flag controls startup wiring

Owners & CI notes
- **Owners:**
  - Backend (connectors, scheduler, metrics): `@backend-team` (primary: `@you`)
  - Frontend (snapshot consumption, mapping): `@frontend-team`
  - Infra (Redis, Prometheus, CI): `@infra`
- **CI Notes:**
  - CI should set `USE_FREE_INGESTION=false` by default to avoid starting the scheduler in tests.
  - Add a fast CI job that runs unit tests for changed files and a separate nightly full-suite job.

Document generated by the development agent to map prioritized features to architecture.
